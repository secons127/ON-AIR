<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ON:AIR - ë¡œê·¸ì¸</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/login.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="login-page">
  <!-- ğŸ¬ ë°°ê²½ ì˜ìƒ -->
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="{{ url_for('static', filename='videos/friend.mp4') }}" type="video/mp4">
  </video>

  <div class="container">
    <div class="auth-stage">
      <div class="auth-card show-front" id="authCard">

        <!-- ë¡œê·¸ì¸ -->
        <div class="login-wrapper face front">
          <div class="login-left">
            <h2>ë¡œê·¸ì¸</h2>
            <form id="login-form">
              <input type="email" placeholder="ì´ë©”ì¼" id="login-email" required>
              <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" id="login-password" required>
              <div class="remember-wrap">
                <label><input type="checkbox" name="remember" /> remember ID</label>
              </div>
              <button type="submit">ë¡œê·¸ì¸</button>
            </form>

            <div class="links">
              ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° | <a href="javascript:void(0)" id="goSignupLink">íšŒì›ê°€ì…</a>
            </div>

            <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ (í´ë˜ìŠ¤ë¡œ ë³€ê²½) -->
            <div class="sns-icons single google-login-btn">
              <img src="{{ url_for('static', filename='assets/icons/google.png') }}" alt="Google ë¡œê·¸ì¸">
              <span>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê¸°</span>
            </div>
            <div class="sns-warning">
              Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹¤ ê²½ìš°,<br>ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>

          <div class="login-right">
            <img class="mic-float" src="{{ url_for('static', filename='assets/icons/mic_logo.png') }}" alt="ë§ˆì´í¬ ë¡œê³ " />
            <h1 id="brandTitle" class="brand">ON:AIR</h1>
            <div class="slogan-wrap">
              <div class="slogan-inner">
                <p class="slogan-text">ë§ì´ ì–´ë ¤ìš´ ë‹¹ì‹ ì„ ìœ„í•œ, ì—°ìŠµì˜ ë¬´ëŒ€</p>
                <p class="desc-sub">â€” ON:AIR.</p>
              </div>
            </div>
            <button type="button" id="goSignup">íšŒì›ê°€ì…</button>
          </div>
        </div>

        <!-- íšŒì›ê°€ì… -->
        <div class="login-wrapper face back">
          <div class="login-left">
            <h2>íšŒì›ê°€ì…</h2>
            <form id="signup-form">
              <input type="text" placeholder="ì•„ì´ë””" id="signup-username" required>
              <input type="email" placeholder="ì´ë©”ì¼" id="signup-email" required>
              <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" id="signup-password" required>
              <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" id="signup-password2" required>
              <button type="submit">ê°€ì…í•˜ê¸°</button>
            </form>

            <div class="links">
              ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="javascript:void(0)" id="goLoginLink">ë¡œê·¸ì¸</a>
            </div>

            <!-- íšŒì›ê°€ì… í˜ì´ì§€ Google ë¡œê·¸ì¸ ë²„íŠ¼ë„ ë™ì¼í•œ í´ë˜ìŠ¤ -->
            <div class="sns-icons single google-login-btn">
              <img src="{{ url_for('static', filename='assets/icons/google.png') }}" alt="Google ë¡œê·¸ì¸">
              <span>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê¸°</span>
            </div>
            <div class="sns-warning">
              Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸/ê°€ì…í•˜ì‹¤ ê²½ìš°,<br>ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>

          <div class="login-right">
            <img class="mic-float" src="{{ url_for('static', filename='assets/icons/mic_logo.png') }}" alt="ë§ˆì´í¬ ë¡œê³ " />
            <h1 class="brand">WELCOME</h1>
            <div class="slogan-wrap">
              <div class="slogan-inner">
                <p class="slogan-text">ì§€ê¸ˆ ë°”ë¡œ ë‹¹ì‹ ë§Œì˜ ì²« ì—°ìŠµì„ ì‹œì‘í•´ìš”.</p>
                <p class="desc-sub">â€” ON:AIR.</p>
              </div>
            </div>
            <button type="button" id="goLogin">ë¡œê·¸ì¸</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <p id="message" style="text-align:center; color:white; font-weight:bold;"></p>

  <!-- í”Œë¦½ ì œì–´ -->
  <script>
    const authCard = document.getElementById('authCard');
    const goSignup = document.getElementById('goSignup');
    const goSignupLink = document.getElementById('goSignupLink');
    const goLogin = document.getElementById('goLogin');
    const goLoginLink = document.getElementById('goLoginLink');

    function lockToBack() { authCard.classList.remove('show-front'); authCard.classList.add('show-back'); }
    function lockToFront() { authCard.classList.remove('show-back'); authCard.classList.add('show-front'); }
    function flipRight() { authCard.classList.add('flip-right'); setTimeout(() => lockToBack(), 600); }
    function flipLeft() { authCard.classList.add('flip-left'); setTimeout(() => lockToFront(), 600); }

    if (goSignup) goSignup.addEventListener('click', flipRight);
    if (goSignupLink) goSignupLink.addEventListener('click', flipRight);
    if (goLogin) goLogin.addEventListener('click', flipLeft);
    if (goLoginLink) goLoginLink.addEventListener('click', flipLeft);

    (function initByQuery(){
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'signup') lockToBack();
      else lockToFront();
    })();

    if (document.referrer && !sessionStorage.getItem("prevUrl")) {
      sessionStorage.setItem("prevUrl", document.referrer);
    }
  </script>

  <!-- Firebase Auth í†µí•© -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
      GoogleAuthProvider, signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBX-GDOIUCtfwXDJXC91z17vj3l4f1fojE",
      authDomain: "onair-project-6df88.firebaseapp.com",
      projectId: "onair-project-6df88",
      storageBucket: "onair-project-6df88.appspot.com",
      messagingSenderId: "269903092073",
      appId: "1:269903092073:web:6fd88d888439182f9a45f8",
      measurementId: "G-6YK7ZS5HD5"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const messageEl = document.getElementById("message");

    // ì¼ë°˜ ë¡œê·¸ì¸(ì´ë©”ì¼,ë¹„ë²ˆ)
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const idToken = await userCredential.user.getIdToken();
        const res = await fetch("/api/login", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨");
        const prevUrl = sessionStorage.getItem("prevUrl") || "/";
        sessionStorage.removeItem("prevUrl");
        window.location.href = prevUrl;
      } catch (error) {
        messageEl.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message;
      }
    });

    // íšŒì›ê°€ì…
    document.getElementById("signup-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("signup-username").value;
      const email = document.getElementById("signup-email").value;
      const password = document.getElementById("signup-password").value;
      const password2 = document.getElementById("signup-password2").value;
      if (password !== password2) return messageEl.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await setDoc(doc(db, "users", user.uid), {
          username, email, avatar_url: user.photoURL || "",
          subscriber: false, level: 1, xp: 0,
          createdAt: new Date()
        });
        const idToken = await user.getIdToken();
        const res = await fetch("/api/login", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨");
        const prevUrl = sessionStorage.getItem("prevUrl") || "/";
        sessionStorage.removeItem("prevUrl");
        window.location.href = prevUrl;
      } catch (error) {
        messageEl.textContent = "íšŒì›ê°€ì… ì‹¤íŒ¨: " + error.message;
      }
    });

    // Google ë¡œê·¸ì¸
    const googleBtns = document.querySelectorAll(".google-login-btn");
    googleBtns.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const ref = doc(db, "users", user.uid);
          const snap = await getDoc(ref);
          if (!snap.exists()) {
            await setDoc(ref, {
              username: user.displayName || "New User",
              email: user.email,
              avatar_url: user.photoURL || "",
              subscriber: false,
              createdAt: new Date()
            });
          }
          const idToken = await user.getIdToken();
          const res = await fetch("/api/login", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken })
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || "ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨");
          const prevUrl = sessionStorage.getItem("prevUrl") || "/";
          sessionStorage.removeItem("prevUrl");
          window.location.href = prevUrl;
        } catch (error) {
          messageEl.textContent = "Google ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message;
        }
      });
    });
  </script>
</body>
</html>
