{% extends "base.html" %}
{% block content %}
<style>
  .feedback-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    max-width: 500px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    text-align: center;
    min-height: 350px;
    overflow: hidden;
  }

  #loader-container { width: 100%; padding: 20px; }
  .progress-bar { width: 100%; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; }
  .progress-bar-inner { width: 0%; height: 100%; background-color: #5865f2; border-radius: 5px; transition: width 0.5s ease-out; }
  .loader-status { margin-top: 15px; font-size: 14px; color: #5865f2; }

  #content-container { display: none; width: 100%; }
  .stars { font-size: 36px; color: #ffc107; margin: 12px 0; }
  .feedback { font-size: 16px; color: #555; line-height: 1.6; min-height: 50px; background: #f9f9f9; border-radius: 8px; padding: 16px; margin-top: 20px; text-align: left; width: 90%; margin-left: auto; margin-right: auto; }
  .buttons { margin-top: 32px; display: flex; gap: 12px; width: 100%; }
  .btn { text-decoration: none; font-size: 16px; font-weight: 600; padding: 12px 0; border-radius: 8px; flex: 1; transition: all 0.2s ease; border: 1px solid #d0d0d0; }
  .btn-retry { background-color: #5865f2; color: white; border-color: #5865f2; }
  .btn-retry:hover { background-color: #4a56d1; }
  .btn-main { background-color: #ffffff; color: #333; }
  .btn-main:hover { background-color: #f9f9f9; }
</style>

<div class="feedback-container">
  <div id="loader-container">
    <h1>AI í”¼ë“œë°± ìƒì„± ì¤‘</h1>
    <p>ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    <div class="progress-bar">
      <div id="progress-bar-inner" class="progress-bar-inner"></div>
    </div>
    <p id="loader-status" class="loader-status">0%</p>
  </div>

  <div id="content-container">
    <h1>ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h1>
    <p>ëŒ€í™” ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ AI í”¼ë“œë°±ì…ë‹ˆë‹¤.</p>
    <div id="stars-display" class="stars"></div>
    <div id="feedback-display" class="feedback"></div>
    <div class="buttons">
      <a href="{{ retry_url }}" class="btn btn-retry">ë‹¤ì‹œí•˜ê¸°</a>
      <a href="{{ main_url }}" class="btn btn-main">ë©”ì¸ìœ¼ë¡œ</a>
    </div>
  </div>
</div>

<script>
  // Flaskì—ì„œ ì „ë‹¬ëœ ì„¸ì…˜ IDì™€ íƒ€ì…(call/chat)
  const sessionId = "{{ session_id }}";
  const sessionType = "{{ session_type }}";  // Flaskì—ì„œ ì „ë‹¬ë¨
  const logType = sessionType === "call" ? "callLogs" : "chatLogs";  // ëª…ì‹œì  êµ¬ë¶„

  window.onload = function() {
    const loaderContainer = document.getElementById("loader-container");
    const contentContainer = document.getElementById("content-container");
    const progressBar = document.getElementById("progress-bar-inner");
    const loaderStatus = document.getElementById("loader-status");

    // 1ï¸âƒ£ ë¡œë”©ë°” ì• ë‹ˆë©”ì´ì…˜
    let percent = 0;
    const interval = setInterval(() => {
      if (percent < 90) { 
        percent += Math.floor(Math.random() * 5) + 1;
        if (percent > 90) percent = 90;
        progressBar.style.width = percent + "%";
        loaderStatus.innerText = percent + "%";
      }
    }, 200);

    // 2ï¸âƒ£ ì‹¤ì œ í”¼ë“œë°± ë°ì´í„° ìš”ì²­
    fetchData(sessionId, interval);
  };

  async function fetchData(sessionId, interval) {
    const loaderContainer = document.getElementById("loader-container");
    const contentContainer = document.getElementById("content-container");
    const progressBar = document.getElementById("progress-bar-inner");
    const loaderStatus = document.getElementById("loader-status");

    const tempKey = sessionStorage.getItem("temp_gemini_key");
    const headers = {};
    if (tempKey) headers['X-API-Key'] = tempKey;

    try {
      const response = await fetch(`/api/feedback_data/${sessionId}`, { method: 'GET', headers });
      const data = await response.json();
      clearInterval(interval);

      if (!response.ok || !data.ok) throw new Error(data.feedback || "í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨");

      progressBar.style.width = "100%";
      loaderStatus.innerText = "100% (ì™„ë£Œ)";

      setTimeout(() => {
        populateContent(data.feedback, data.score);
        loaderContainer.style.display = "none";
        contentContainer.style.display = "block";
      }, 500);
    } catch (error) {
      clearInterval(interval);
      console.error("Feedback fetch error:", error);
      populateContent(error.message || "ì˜¤ë¥˜ ë°œìƒ", 0);
      loaderContainer.style.display = "none";
      contentContainer.style.display = "block";
    }
  }

  // âœ… Firestore í”¼ë“œë°± ì €ì¥
  async function populateContent(feedback, score) {
    const starsDisplay = document.getElementById("stars-display");
    const feedbackDisplay = document.getElementById("feedback-display");

    const scoreInt = parseInt(score, 10) || 0;
    starsDisplay.innerText = "â˜…".repeat(scoreInt) + "â˜†".repeat(5 - scoreInt);
    feedbackDisplay.innerText = feedback;

    try {
      const { auth, db, onAuthStateChanged, collection, getDocs, query, orderBy, limit, serverTimestamp, updateDoc } = window;
      if (!auth || !db) {
        console.error("âŒ Firebase ì´ˆê¸°í™”ê°€ ì•ˆ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      // ğŸ”¸ ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸°
      await new Promise(resolve => {
        onAuthStateChanged(auth, user => {
          if (user) resolve(user);
        });
      });

      const user = auth.currentUser;
      if (!user) return console.warn("âš ï¸ ë¡œê·¸ì¸ í•„ìš”: í”¼ë“œë°± ì €ì¥ ê±´ë„ˆëœ€");

      // ğŸ”¸ Flaskì—ì„œ ì „ë‹¬ë°›ì€ logType(callLogs / chatLogs)ì— ì €ì¥
      const userLogsRef = collection(db, "users", user.uid, logType);

      // ğŸ”¸ ê°€ì¥ ìµœê·¼ ë¡œê·¸(ì¢…ë£Œ ì‹œê°„ ê¸°ì¤€) íƒìƒ‰
      let snapshot = await getDocs(query(userLogsRef, orderBy("endedAt", "desc"), limit(1)));

      // ğŸ”¸ ë§Œì•½ endedAtì´ ì—†ë‹¤ë©´ startedAt ê¸°ì¤€ìœ¼ë¡œ ë³´ì¡° íƒìƒ‰
      if (snapshot.empty) {
        snapshot = await getDocs(query(userLogsRef, orderBy("startedAt", "desc"), limit(1)));
      }

      if (!snapshot.empty) {
        const latestDoc = snapshot.docs[0];

        // feedbackì„ í•˜ìœ„ ì»¬ë ‰ì…˜ì´ ì•„ë‹Œ í•„ë“œë¡œ ì €ì¥
        await updateDoc(latestDoc.ref, {
          feedback: {
            score: scoreInt,
            content: feedback,
            createdAt: serverTimestamp(),
          },
        });

        console.log(`âœ… Firestore ${logType} â†’ feedback.score ì €ì¥ ì™„ë£Œ`);

        // âœ… í”¼ë“œë°± ì €ì¥ í›„ ë°°ì§€ ìë™ ë¶€ì—¬ ì‹¤í–‰
        await checkAndAwardBadges(user.uid);
        
      } else {
        console.warn("âš ï¸ ìµœê·¼ ë¡œê·¸ ë¬¸ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (e) {
      console.error("âŒ Firestore feedback ì €ì¥ ì‹¤íŒ¨:", e);
    }
  }
</script>
{% endblock %}