{% extends "base.html" %}

{% block title %}ON:AIR - ë§ˆì´í˜ì´ì§€{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/mypage.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<main class="mypage container">
  <!-- ì¢Œì¸¡ í”„ë¡œí•„ -->
  <aside class="profile">
    <div class="avatar-big" id="avatar">M</div>
    <h2 class="username" id="username">ì‚¬ìš©ì</h2>
    <p class="level" id="level">ë ˆë²¨ 1</p>
    <div class="progress">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    <p class="next" id="progressText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 100%</p>
    <button class="btn-edit">í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°</button>
  </aside>

  <!-- ì¤‘ì•™ ì½˜í…ì¸  -->
  <section class="content">
    <!-- í•™ìŠµ/í›ˆë ¨ í†µê³„ -->
    <div class="stats">
      <div class="card attendance">
        <h3>í†µí™”/ì±„íŒ… ê¸°ë¡</h3>
        <ul id="attendanceList">
          <li>ì´ í†µí™” ì‹œë®¬ë ˆì´ì…˜ <strong>0íšŒ</strong></li>
          <li>ì´ ì±„íŒ… í›ˆë ¨ <strong>0íšŒ</strong></li>
          <li>ìµœê·¼ í•™ìŠµ ê¸°ë¡ ì—†ìŒ</li>
        </ul>
      </div>
      <div class="card summary">
        <h3>ëˆ„ì  í•™ìŠµ í˜„í™©</h3>
        <ul id="summaryList">
          <li>ê°€ì¥ ë†’ì€ í”¼ë“œë°± ì ìˆ˜ <strong>0ì </strong></li>
          <li>í‰ê·  í”¼ë“œë°± ë³€í™”ìœ¨ <strong>0ì </strong></li>
          <li>AI í”¼ë“œë°± ì ìˆ˜ í‰ê·  <strong id="avgFeedback">0ì </strong></li>
        </ul>
      </div>
    </div>

    <!-- í”¼ë“œë°± ê·¸ë˜í”„ -->
    <div class="card feedback">
      <h3>ìµœê·¼ 5íšŒ í”¼ë“œë°± ì ìˆ˜ ì¶”ì´</h3>
      <canvas id="feedbackChart"></canvas>
    </div>

    <!-- ìµœê·¼ í”¼ë“œë°± ì¹´ë“œ 3ê°œ -->
    <div class="card feedback-list">
      <h3>ìµœê·¼ í”¼ë“œë°±</h3>
      <ul id="recentFeedbackList">
        <li>ìµœê·¼ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</li>
      </ul>
    </div>

    <!-- íšë“í•œ ë°°ì§€ -->
    <div class="card badges">
      <h3>íšë“í•œ ë°°ì§€ <span id="badgeCount">0ê°œ</span></h3>
      <div class="badge-list" id="badgeList">
        <p>ì•„ì§ íšë“í•œ ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- ì±Œë¦°ì§€ ë‚´ì—­ -->
    <div class="card challenges">
      <h3>ì±Œë¦°ì§€ ë‚´ì—­ <span id="challengeSummary">0ê°œ ì„±ê³µ / 0ê°œ ì°¸ì—¬</span></h3>
      <ul id="challengeList">
        <li>ì°¸ì—¬í•œ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      </ul>
    </div>
  </section>
</main>
{% endblock %}

{% block scripts %}
<script type="module">
  import { getAuth, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, collection, getDocs, updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import "/static/js/firebase-init.js";

  const auth = window.auth;
  const db = window.db;
  let feedbackChart;

  // í”¼ë“œë°± ì ìˆ˜ í†µê³„ ê³„ì‚° í•¨ìˆ˜ 
  async function getFeedbackStats(userId) {
    const subCollections = ["callLogs", "chatLogs"];
    const feedbackData = [];

    // ğŸ”¹ ê° ì„œë¸Œì»¬ë ‰ì…˜ì—ì„œ í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
    for (const sub of subCollections) {
      const q = collection(db, "users", userId, sub);
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (
          data.feedback &&
          typeof data.feedback.score === "number" &&
          data.feedback.score >= 0 &&
          data.feedback.score <= 5
        ) {
          feedbackData.push({
            score: data.feedback.score,
            createdAt: data.feedback.createdAt?.toDate
              ? data.feedback.createdAt.toDate()
              : new Date(),
          });
        }
      });
    }

    // ğŸ”¹ í”¼ë“œë°±ì´ ì—†ì„ ë•Œ
    if (feedbackData.length === 0) {
      return { avg: 0, highest: 0, changeRate: 0 };
    }

    // ğŸ”¹ ì‹œê°„ìˆœ ì •ë ¬
    feedbackData.sort((a, b) => a.createdAt - b.createdAt);

    // ğŸ”¹ ìµœê·¼ 5ê°œë§Œ ì¶”ì¶œ
    const recent = feedbackData.slice(-5);
    const scores = recent.map((f) => f.score);

    const avg = (scores.reduce((a, b) => a + b) / scores.length).toFixed(1);
    const highest = Math.max(...scores);

    // ğŸ”¹ ë³€í™”ìœ¨ ê³„ì‚° (ì´ì „ í‰ê·  vs ë§ˆì§€ë§‰ ì ìˆ˜)
    let changeRate = 0;
    if (scores.length >= 2) {
      const prevAvg =
        scores.slice(0, scores.length - 1).reduce((a, b) => a + b, 0) /
        (scores.length - 1);
      const last = scores[scores.length - 1];
      changeRate = (last - prevAvg).toFixed(1);
    }

    return { avg, highest, changeRate };
  }

  // ìµœê·¼ í”¼ë“œë°± 3ê°œ í‘œì‹œ í•¨ìˆ˜
  async function loadRecentFeedback(userId) {
    const subCollections = ["callLogs", "chatLogs"];
    const feedbacks = [];

    for (const sub of subCollections) {
      const q = collection(db, "users", userId, sub);
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.feedback && data.feedback.content) {
          feedbacks.push({
            type: sub === "callLogs" ? "Call" : "Chat",
            scenario: data.scenarioTitle || data.scenario || "ì•Œ ìˆ˜ ì—†ëŠ” ì‹œë‚˜ë¦¬ì˜¤",
            comment: data.feedback.content,
            score: data.feedback.score || 0,
            createdAt: data.feedback.createdAt?.toDate
              ? data.feedback.createdAt.toDate()
              : new Date(),
          });
        }
      });
    }

    feedbacks.sort((a, b) => b.createdAt - a.createdAt);
    const recent = feedbacks.slice(0, 3);
    const list = document.getElementById("recentFeedbackList");
    list.innerHTML = "";

    if (recent.length === 0) {
      list.innerHTML = "<li>ì•„ì§ ë°›ì€ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
      return;
    }

    recent.forEach((f) => {
      const li = document.createElement("li");
      const date = f.createdAt.toLocaleDateString("ko-KR", { month: "short", day: "numeric" });
      li.innerHTML = `
        <p class="scenario-label">${f.type} | <strong>${f.scenario}</strong></p>
        <p><strong>â­ ${f.score}ì </strong> | ${f.comment}</p>
        <span style="font-size: 13px; color: #777;">${date}</span>
      `;
      list.appendChild(li);
    });
  }

  // ìµœê·¼ 5íšŒ í”¼ë“œë°± ì ìˆ˜ ì¶”ì´ ê·¸ë˜í”„
  async function updateFeedbackChart(userId) {
    const subCollections = ["callLogs", "chatLogs"];
    const allScores = [];

    for (const sub of subCollections) {
      const q = collection(db, "users", userId, sub);
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.feedback && typeof data.feedback.score === "number") {
          allScores.push({
            score: data.feedback.score,
            createdAt: data.feedback.createdAt?.toDate ? data.feedback.createdAt.toDate() : new Date()
          });
        }
      });
    }

    allScores.sort((a, b) => a.createdAt - b.createdAt);

    const recentScores = allScores.slice(-5);
    const labels = recentScores.map((_, i) => `#${i + 1}`);
    const scores = recentScores.map((item) => item.score);

    const ctx = document.getElementById("feedbackChart").getContext("2d");
    if (feedbackChart) feedbackChart.destroy();

    feedbackChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "ìµœê·¼ í”¼ë“œë°± ì ìˆ˜ ì¶”ì´",
          data: scores,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59,130,246,0.15)",
          borderWidth: 2,
          pointBackgroundColor: "#3b82f6",
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 5, title: { display: true, text: "ì ìˆ˜" } },
          x: { title: { display: true, text: "ìµœê·¼ íšŒì°¨" } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => `ì ìˆ˜: ${ctx.parsed.y}` } }
        }
      }
    });
  }

  // Firestoreì—ì„œ ë°°ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadBadges(userId) {
    try {
      const badgeRef = collection(db, "users", userId, "badges");
      const badgeSnap = await getDocs(badgeRef);
      const badgeList = document.getElementById("badgeList");
      const badgeCount = document.getElementById("badgeCount");

      badgeList.innerHTML = "";
      badgeCount.textContent = `${badgeSnap.size}ê°œ`;

      if (badgeSnap.empty) {
        badgeList.innerHTML = "<p>ì•„ì§ íšë“í•œ ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      badgeSnap.forEach((docSnap) => {
        const b = docSnap.data();
        const div = document.createElement("div");
        div.className = "badge-item";
        div.style.display = "inline-block";
        div.style.margin = "10px";
        div.style.textAlign = "center";
        div.innerHTML = `
          <div style="font-size: 36px;">${b.emoji || "ğŸ…"}</div>
          <p style="margin-top: 5px;">${b.name || "ë°°ì§€"}</p>
        `;
        badgeList.appendChild(div);
      });
    } catch (err) {
      console.error("âŒ ë°°ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    }
  }

  // ì‚¬ìš©ì ë¡œê·¸ì¸ ê°ì§€
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    console.log("âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì UID:", user.uid);

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const u = userSnap.data();
      document.getElementById("username").textContent = u.username || "ì‚¬ìš©ì";

      let xp = u.xp || 0;
      let level = u.level || 1;
      if (xp >= 50) {
        level += Math.floor(xp / 50);
        xp = xp % 50;
        await updateDoc(userRef, { level, xp });
      }

      const progress = Math.min((xp / 50) * 100, 100);
      document.getElementById("level").textContent = `ë ˆë²¨ ${level}`;
      document.getElementById("progressBar").style.width = `${progress}%`;
      document.getElementById("progressText").textContent =
        `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${Math.max(0, (100 - progress).toFixed(1))}%`;

      if (u.avatar_url) {
        const avatarEl = document.getElementById("avatar");
        avatarEl.textContent = "";
        avatarEl.style.backgroundImage = `url(${u.avatar_url})`;
        avatarEl.style.backgroundSize = "cover";
      }
    }

    const callLogsRef = collection(db, "users", user.uid, "callLogs");
    const chatLogsRef = collection(db, "users", user.uid, "chatLogs");
    const [callLogsSnap, chatLogsSnap] = await Promise.all([
      getDocs(callLogsRef),
      getDocs(chatLogsRef)
    ]);

    document.getElementById("attendanceList").innerHTML = `
      <li>ì´ í†µí™” ì‹œë®¬ë ˆì´ì…˜ <strong>${callLogsSnap.size}íšŒ</strong></li>
      <li>ì´ ì±„íŒ… í›ˆë ¨ <strong>${chatLogsSnap.size}íšŒ</strong></li>
      ${
        callLogsSnap.size + chatLogsSnap.size > 0
          ? `<li>ìµœê·¼ ${callLogsSnap.size + chatLogsSnap.size >= 7 ? "7ì¼ ì—°ì† í•™ìŠµ ğŸ”¥" : "ê¾¸ì¤€íˆ í•™ìŠµ ì¤‘ ğŸ‘"}</li>`
          : "<li>ìµœê·¼ í•™ìŠµ ê¸°ë¡ ì—†ìŒ</li>"
      }
    `;

    const { avg, highest, changeRate } = await getFeedbackStats(user.uid);
    document.getElementById("summaryList").innerHTML = `
      <li>ê°€ì¥ ë†’ì€ í”¼ë“œë°± ì ìˆ˜ <strong>${highest.toFixed(1)}ì </strong></li>
      <li>í‰ê·  í”¼ë“œë°± ë³€í™”ìœ¨ <strong>${changeRate >= 0 ? "+" + changeRate : changeRate}ì </strong></li>
      <li>AI í”¼ë“œë°± ì ìˆ˜ í‰ê·  <strong>${avg}ì </strong></li>
    `;

    await updateFeedbackChart(user.uid);
    await loadRecentFeedback(user.uid);
    await loadBadges(user.uid);  // ë°°ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
  });
</script>
{% endblock %}