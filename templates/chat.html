{% extends "base.html" %}

{% block title %}ON:AIR - 채팅 연습{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/chat.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --card-w: 860px;
    --card-min-h: 300px;
  }
  body {
    background: #0f1115;
    color: #eaeef5;
    font-family: 'Noto Sans KR', sans-serif;
  }

  .stage {
    min-height: calc(100vh - 120px);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 140px 24px 80px;
    background:
      radial-gradient(850px 450px at 8% 18%, rgba(70, 80, 160, .15) 0%, rgba(70, 80, 160, 0) 60%),
      radial-gradient(900px 550px at 92% 85%, rgba(120, 70, 200, .14) 0%, rgba(120, 70, 200, 0) 65%);
  }
  .chat-card {
    width: min(var(--card-w), 100%);
    min-height: var(--card-min-h);
    background: #181a20;
    border: 1px solid rgba(255, 255, 255, .06);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    overflow: hidden;
  }
  .card-head {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: #14161b;
    border-bottom: 1px solid rgba(255, 255, 255, .06);
    font-size: 14px;
  }
  .card-head .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #7aa2ff;
  }
  .card-head .title {
    font-weight: 700;
  }
  .card-head .hint {
    color: #9aa4b2;
    margin-left: 6px;
  }
  .card-head .spacer {
    flex: 1;
  }

  .panel {
    display: none;
    padding: 24px;
  }
  .panel.active {
    display: block;
  }

  .center-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #222733;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #cbd5e1;
    font-size: 24px;
    border: 1px solid rgba(255, 255, 255, .08);
  }
  .agent-name {
    font-weight: 800;
    letter-spacing: .3px;
  }
  .sub-hint {
    color: #a9b1bd;
    font-size: 13px;
  }

  .rounds-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    color: #cbd5e1;
  }
  .rounds-selector select,
  .rounds-selector input {
    padding: 7px 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, .12);
    background: #1b1f28;
    color: #e4e7ee;
    font-size: 14px;
  }

  .chat-window {
    width: 100%;
    height: 380px;
    margin-top: 6px;
    overflow-y: auto;
    padding: 12px 12px 14px;
    background: #12141a;
    color: #e9ecf3;
    border: 1px solid rgba(255, 255, 255, .06);
    border-radius: 10px;
  }

  
  .msg{
  white-space: pre-wrap;         /* 개행 보존 + 자동 줄바꿈 */
  overflow-wrap: anywhere;       /* 공백 없는 초장문도 강제 줄바꿈 */
  word-break: keep-all;          /* 한국어 단어 중간 분리 최소화 */
  /* fallback 겸 호환성 용 */
  word-wrap: break-word;
  hyphens: auto;                 /* 하이픈 분할 가능한 언어에 유용 */
}
  .msg-user {
    
    color: #ffffff;
    margin-left: auto;
    text-align: right;
    border-radius: 20px 20px 5px 20px; 
  }
  .msg-ai {
     
  color: #e9ecf3;        
  margin-right: auto;
  border-radius: 25px;        
}
  

  .msg-system {
    text-align: center;
    color: #ffc107;
    font-style: italic;
    font-size: 13px;
  }

  .chat-input-area {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    width: 100%;
  }
  .chat-input {
    flex: 1 1 auto;
    min-width: 0;
    height: 46px;
    padding: 0 14px;
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, .1);
    background: #1b1f28;
    color: #fff;
  }
  .pill-btn {
    flex: 0 0 auto;
    height: 46px;
    padding: 0 16px;
    border: none;
    border-radius: 22px;
    background: #394258;
    color: #fff;
    cursor: pointer;
  }
  .pill-btn:hover {
    background: #4a5674;
  }

  .start-btn {
    min-width: 200px;
    height: 44px;
    border: none;
    border-radius: 12px;
    background: #6c7bff;
    color: #fff;
    font-weight: 700;
  }
  .start-btn:hover {
    background: #5f6ee6;
  }
</style>
{% endblock %}

{% block content %}
<div class="stage">
  <div class="chat-card">
    <div class="card-head">
      <span class="dot"></span>
      <span class="title">ON:AIR AI 채팅 연습</span>
      <span class="hint">시나리오: {{ scenario or '일반 문의' }}</span>
      <div class="spacer"></div>
    </div>

    <div id="chat-setup" class="panel active">
      <div class="center-wrap" style="gap:14px;">
        <div class="avatar"><i class="fa-solid fa-comments"></i></div>
        <div class="agent-name">채팅 연습 설정</div>
        <div class="rounds-selector">
          <label for="rounds-select">대화 턴 수</label>
          <select id="rounds-select" onchange="toggleRoundsInput()">
            <option value="3">3 턴</option>
            <option value="5" selected>5 턴</option>
            <option value="7">7 턴</option>
            <option value="10">10 턴</option>
            <option value="custom">직접 입력</option>
          </select>
          <input type="number" id="rounds-input" min="1" max="20" value="5" placeholder="턴 수" style="width:60px; display:none; text-align:center;">
        </div>
        <button onclick="startChat()" class="start-btn">연습 시작</button>
      </div>
    </div>

    <div id="chat-panel" class="panel">
      <div class="center-wrap" style="gap:10px;">
        <div class="avatar"><i class="fa-solid fa-user"></i></div>
        <div class="agent-name">{{ scenario or '채팅 연습' }} (진행중)</div>

        <div id="chat-window" class="chat-window"></div>

        <div class="chat-input-area" id="chat-input-area">
          <input id="chat-input" type="text" placeholder="메시지 입력...(Enter)" class="chat-input" onkeydown="if(event.key==='Enter') sendChat();">
          <button onclick="sendChat()" class="pill-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  let chatSessionId = null;
  let currentChatId = null; // Firestore chatLogs 문서 ID
  const scenario = "{{ scenario }}";

  // 직접 입력 토글
  function toggleRoundsInput() {
    const select = document.getElementById("rounds-select");
    const input = document.getElementById("rounds-input");
    input.style.display = (select.value === "custom") ? "inline-block" : "none";
    if (select.value === "custom") input.focus();
  }

  // Firestore 메시지 저장
  async function saveChatMessage(sender, text) {
    const user = auth.currentUser;
    if (!user || !currentChatId) return;
    try {
      await addDoc(collection(db, "users", user.uid, "chatLogs", currentChatId, "chatMessages"), {
        sender,
        text,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error("❌ 메시지 저장 실패:", e);
    }
  }

  // 채팅 시작
  async function startChat() {
    const setup = document.getElementById("chat-setup");
    const panel = document.getElementById("chat-panel");
    const roundsSelect = document.getElementById("rounds-select");
    const roundsInput = document.getElementById("rounds-input");

    let rounds = (roundsSelect.value === "custom") ?
      parseInt(roundsInput.value, 10) :
      parseInt(roundsSelect.value, 10);
    if (isNaN(rounds) || rounds < 1 || rounds > 20) {
      alert("턴 수는 1~20 사이로 입력해주세요.");
      return;
    }

    try {
      // 1) 세션 생성
      const res = await fetch("/api/chat/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          topic: "채팅 훈련",
          user_role: "customer",
          scenario,
          rounds
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      chatSessionId = data.session_id;

      // 2) Firestore 로그 문서 생성
      const user = auth.currentUser;
      if (user) {
        const chatDoc = await addDoc(collection(db, "users", user.uid, "chatLogs"), {
          scenario,
          rounds,
          startedAt: serverTimestamp()
        });
        currentChatId = chatDoc.id;

        // XP 적립 1회
        const {
          addXP
        } = await import("/static/js/xp-level.js");
        await addXP("chat");
      }

      // 3) UI 전환 + 오프닝 출력
      setup.classList.remove("active");
      setup.style.display = "none";
      panel.classList.add("active");
      addChat("ai", data.opening);
      document.getElementById("chat-input").focus();

    } catch (e) {
      addChat("system", `❌ 채팅 시작 실패: ${e.message}`);
      console.error(e);
    }
  }

  // 메시지 전송
  async function sendChat() {
    const input = document.getElementById("chat-input");
    const text = input.value.trim();
    if (!text || !chatSessionId) return;

    addChat("user", text);
    input.value = "";
    input.disabled = true;

    try {
      const res = await fetch("/api/chat/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          session_id: chatSessionId,
          text
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.reply !== undefined) {
        const replyText = data.reply && data.reply.trim() ? data.reply : "(응답 없음)";
        addChat("ai", replyText);
      }

      if (data.ended) {
        addChat("system", "대화가 종료되었습니다. 잠시 후 피드백 페이지로 이동합니다...");
        document.getElementById("chat-input-area").style.pointerEvents = "none";
        document.getElementById("chat-input-area").style.opacity = "0.5";
        await endChat();
        setTimeout(() => window.location.href = '/feedback/' + chatSessionId, 1500);
      } else {
        input.disabled = false;
        input.focus();
      }
    } catch (e) {
      addChat("system", `❌ 메시지 전송 실패: ${e.message}`);
      console.error(e);
      input.disabled = false;
    }
  }

  // 메시지 렌더 + 저장
  function addChat(role, text) {
    const win = document.getElementById("chat-window");
    const div = document.createElement("div");

    if (role === "user") {
      div.className = "msg msg-user";
      div.innerHTML = `<span>${text}</span>`;
      saveChatMessage("user", text);
    } else if (role === "ai") {
      div.className = "msg msg-ai";
      div.innerHTML = `<span>${text}</span>`;
      saveChatMessage("ai", text);
    } else {
      div.className = "msg-system";
      div.textContent = text;
    }

    win.appendChild(div);
    win.scrollTop = win.scrollHeight;
  }

  // 종료 기록
  async function endChat() {
    const user = auth.currentUser;
    if (user && currentChatId) {
      try {
        await updateDoc(doc(db, "users", user.uid, "chatLogs", currentChatId), {
          endedAt: serverTimestamp()
        });
      } catch (e) {
        console.error("❌ 채팅 종료 기록 실패:", e);
      }
    }
  }

  // 로그인 감시 (옵션)
  document.addEventListener("DOMContentLoaded", () => {
    const checkAuth = setInterval(() => {
      if (auth.currentUser) {
        clearInterval(checkAuth);
      }
    }, 500);
  });

  window.addEventListener("beforeunload", () => {
    if (auth.currentUser && currentChatId) {
      endChat();
    }
  });
</script>
{% endblock %}